<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã‚¹ã‚³ã‚¢ä»˜ãé™å®šã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ </title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* ãƒªã‚»ãƒƒãƒˆCSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            background-image: url('assets/images/janken_background_img.webp');
            background-size: cover;
            background-position: center;
            color: #fff;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        h1 {
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #000;
        }

        #game-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
        }

        .side {
            width: 45%;
            min-width: 300px;
        }

        .character-placeholder {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1.5em;
            box-shadow: 2px 2px 10px #000;
        }

        .hand {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .card {
            width: 60px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .card:hover {
            transform: scale(1.1);
            border-color: #ffd700;
        }

        .selected {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.9);
            animation: rotate 0.5s linear;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #confirm-button, #reset-button, #continue-button, #mute-button, #history-button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #confirm-button {
            background-color: #28a745;
            color: #fff;
        }

        #confirm-button:hover {
            background-color: #218838;
        }

        #reset-button {
            background-color: #dc3545;
            color: #fff;
            display: none;
        }

        #reset-button:hover {
            background-color: #c82333;
        }

        #continue-button {
            background-color: #007bff;
            color: #fff;
            display: none;
        }

        #continue-button:hover {
            background-color: #0069d9;
        }

        #mute-button {
            background-color: #17a2b8;
            color: #fff;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        #mute-button:hover {
            background-color: #138496;
        }

        #history-button {
            background-color: #6c757d;
            color: #fff;
        }

        #history-button:hover {
            background-color: #5a6268;
        }

        #message {
            margin-bottom: 20px;
            font-size: 1.5em;
            min-height: 2em;
            text-shadow: 1px 1px 2px #000;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 10px;
            max-width: 600px;
            margin: 0 auto 20px auto;
        }

        .result {
            display: none;
            justify-content: center;
            gap: 50px;
            margin-bottom: 20px;
        }

        .result-icon {
            font-size: 3em;
        }

        .winner {
            animation: fadeIn 1s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px;
            margin-bottom: 20px;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px #000;
        }

        .score {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 2px 2px 10px #000;
        }

        /* ã‚´ãƒ¼ãƒ«ãƒ‰è¡¨ç¤º */
        .gold {
            background-color: rgba(255, 215, 0, 0.8);
            color: #000;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 2px 2px 10px #000;
            font-weight: bold;
            order: -1;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¹ã‚¿ã‚¤ãƒ« */
        #history-modal, #betting-modal, #reset-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #history-content, #betting-content, #reset-content {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            color: #f0f0f0;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        #close-history, #close-betting, #close-reset {
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
        }

        #history-list {
            list-style: none;
            text-align: left;
            margin-top: 20px;
        }

        /* æ›ã‘é‡‘ãƒœã‚¿ãƒ³ */
        .bet-button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.2em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: #ffc107;
            color: #000;
        }

        .bet-button:hover {
            background-color: #e0a800;
        }

        /* ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #reset-content p {
            margin: 20px 0;
            font-size: 1.2em;
        }

        /* ã‚°ãƒ©ãƒ•ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #history-chart {
            max-width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        /* ã‚¿ãƒƒãƒãƒ‡ãƒã‚¤ã‚¹å‘ã‘ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        @media (max-width: 800px) {
            .card {
                width: 70px;
                height: 70px;
                font-size: 2.2em;
            }

            #confirm-button, #reset-button, #continue-button, #mute-button, #history-button {
                width: 100%;
                padding: 12px;
                font-size: 1.2em;
            }

            #scoreboard {
                flex-direction: column;
                gap: 20px;
            }

            #message {
                font-size: 1.2em;
            }

            #history-chart {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’å³ä¸Šã«é…ç½® -->
    <button id="mute-button">ãƒŸãƒ¥ãƒ¼ãƒˆ</button>

    <!-- èƒŒæ™¯éŸ³æ¥½ -->
    <audio id="bgm" src="assets/sounds/janken_bgm.mp3" autoplay loop></audio>

    <h1>ã‚¹ã‚³ã‚¢ä»˜ãé™å®šã˜ã‚ƒã‚“ã‘ã‚“ã‚²ãƒ¼ãƒ </h1>
    <div id="game-container">
        <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¨ãƒªã‚¢ -->
        <div class="side">
            <div class="character-placeholder" id="player-character">
                ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
            </div>
            <div class="hand" id="player-hand">
                <!-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰‹æœ­ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
            <button id="confirm-button" style="display: none;">ç¢ºå®š</button>
        </div>
        <!-- AIã‚¨ãƒªã‚¢ -->
        <div class="side">
            <div class="character-placeholder" id="ai-character">
                AI
            </div>
            <div class="hand" id="ai-hand">
                <!-- AIã®æ‰‹æœ­ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ -->
            </div>
        </div>
    </div>
    <div id="message">
        ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ï¼ å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§ãã ã•ã„ã€‚
    </div>
    <div class="result" id="result-display">
        <div class="player">
            <h3>ã‚ãªãŸã®é¸æŠ</h3>
            <span class="result-icon" id="player-choice-icon">-</span>
        </div>
        <div class="computer">
            <h3>AIã®é¸æŠ</h3>
            <span class="result-icon" id="computer-choice-icon">-</span>
        </div>
    </div>
    <div id="scoreboard">
        <div class="gold">æ‰€æŒé‡‘: <span id="player-gold">1000</span>ã‚´ãƒ¼ãƒ«ãƒ‰</div>
        <div class="score">ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: <span id="player-score">0</span></div>
        <div class="score">AIã®ã‚¹ã‚³ã‚¢: <span id="ai-score">0</span></div>
    </div>
    <button id="reset-button" style="display: none;">ãƒªã‚»ãƒƒãƒˆ</button>
    <button id="continue-button" style="display: none;">æ¬¡ã®ã‚²ãƒ¼ãƒ ã‚’ç¶šã‘ã‚‹</button>
    <button id="history-button">ã‚²ãƒ¼ãƒ å±¥æ­´</button>

    <!-- ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
    <audio id="choice-sound" src="assets/sounds/choice.mp3"></audio>
    <audio id="gold-sound" src="assets/sounds/gold.mp3"></audio>
    <audio id="select-sound" src="assets/sounds/select.mp3"></audio>
    <audio id="win-sound" src="assets/sounds/win.mp3"></audio>
    <audio id="lose-sound" src="assets/sounds/lose.mp3"></audio>
    <audio id="tie-sound" src="assets/sounds/tie.mp3"></audio>
    <audio id="reward-sound" src="assets/sounds/reward.mp3"></audio>

    <!-- ã‚²ãƒ¼ãƒ å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="history-modal">
        <div id="history-content">
            <span id="close-history">&times;</span>
            <h2>ã‚²ãƒ¼ãƒ å±¥æ­´</h2>
            <canvas id="history-chart"></canvas>
            <ul id="history-list"></ul>
        </div>
    </div>

    <!-- æ›ã‘é‡‘é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="betting-modal">
        <div id="betting-content">
            <span id="close-betting">&times;</span>
            <h2>æ›ã‘é‡‘ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
            <button class="bet-button" data-bet="100">100ã‚´ãƒ¼ãƒ«ãƒ‰</button>
            <button class="bet-button" data-bet="300">300ã‚´ãƒ¼ãƒ«ãƒ‰</button>
            <button class="bet-button" data-bet="500">500ã‚´ãƒ¼ãƒ«ãƒ‰</button>
            <button class="bet-button" data-bet="1000">1000ã‚´ãƒ¼ãƒ«ãƒ‰</button>
            <button class="bet-button" data-bet="all-in">å…¨é¡ãƒ™ãƒƒãƒˆ</button>
        </div>
    </div>

    <!-- ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="reset-modal">
        <div id="reset-content">
            <span id="close-reset">&times;</span>
            <h2>ã‚²ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ</h2>
            <p>ãƒªã‚»ãƒƒãƒˆã™ã‚‹ã¨æ‰€æŒé‡‘ãŒ1000ã‚´ãƒ¼ãƒ«ãƒ‰ã«æˆ»ã‚Šã€ã‚²ãƒ¼ãƒ å±¥æ­´ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ</p>
            <button id="confirm-reset-button" class="bet-button">ã¯ã„</button>
            <button id="cancel-reset-button" class="bet-button">ã„ã„ãˆ</button>
        </div>
    </div>

    <!-- JavaScriptã®çµ±åˆ -->
    <script>
        // ã‚²ãƒ¼ãƒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®å®šç¾©
        const GameModule = (() => {
            // é¸æŠè‚¢ã®å®šç¾©
            const choices = {
                'rock': 'âœŠ',
                'paper': 'âœ‹',
                'scissors': 'âœŒï¸'
            };

            // ã‚¹ã‚³ã‚¢å¤‰æ•°
            let playerScore = 0;
            let aiScore = 0;

            // ã‚´ãƒ¼ãƒ«ãƒ‰å¤‰æ•°
            let playerGold = 1000;

            // æ›ã‘é‡‘
            let currentBet = 0;

            // æ‰‹æœ­
            let playerHand = [];
            let aiHand = [];

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠ
            let playerSelected = null;
            let playerSelectedIndex = null;

            // ãƒ©ã‚¦ãƒ³ãƒ‰æ•°
            let roundCount = 0;
            const maxRounds = 5;

            // ãƒ•ãƒ©ã‚°: å…¨é¡ãƒ™ãƒƒãƒˆã‹ã©ã†ã‹
            let isAllIn = false;

            // DOMè¦ç´ ã®å–å¾—
            const confirmButton = document.getElementById('confirm-button');
            const resetButton = document.getElementById('reset-button');
            const continueButton = document.getElementById('continue-button');
            const muteButton = document.getElementById('mute-button');
            const historyButton = document.getElementById('history-button');

            const messageDiv = document.getElementById('message');
            const resultDisplay = document.getElementById('result-display');
            const playerChoiceIcon = document.getElementById('player-choice-icon');
            const computerChoiceIcon = document.getElementById('computer-choice-icon');

            const playerHandDiv = document.getElementById('player-hand');
            const aiHandDiv = document.getElementById('ai-hand');

            const playerScoreSpan = document.getElementById('player-score');
            const aiScoreSpan = document.getElementById('ai-score');
            const playerGoldSpan = document.getElementById('player-gold'); // ã‚´ãƒ¼ãƒ«ãƒ‰è¡¨ç¤º

            const bgm = document.getElementById('bgm');

            // ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆã®å–å¾—
            const choiceSound = document.getElementById('choice-sound');
            const goldSound = document.getElementById('gold-sound');
            const selectSound = document.getElementById('select-sound');
            const winSound = document.getElementById('win-sound');
            const loseSound = document.getElementById('lose-sound');
            const tieSound = document.getElementById('tie-sound');
            const rewardSound = document.getElementById('reward-sound'); // æ–°è¦å–å¾—

            // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã®å–å¾—
            const bettingModal = document.getElementById('betting-modal');
            const bettingContent = document.getElementById('betting-content');
            const closeBetting = document.getElementById('close-betting');
            const bettingButtons = document.querySelectorAll('.bet-button');

            const historyModal = document.getElementById('history-modal');
            const historyContent = document.getElementById('history-content');
            const closeHistory = document.getElementById('close-history');

            const resetModal = document.getElementById('reset-modal');
            const resetContent = document.getElementById('reset-content');
            const closeReset = document.getElementById('close-reset');
            const confirmResetButton = document.getElementById('confirm-reset-button');
            const cancelResetButton = document.getElementById('cancel-reset-button');

            // åˆæœŸæ‰‹æœ­ç”Ÿæˆé–¢æ•°
            function generateHand() {
                const hand = [];
                const options = ['rock', 'paper', 'scissors'];
                for (let i = 0; i < 5; i++) {
                    const randomChoice = options[Math.floor(Math.random() * options.length)];
                    hand.push(randomChoice);
                }
                return hand;
            }

            // æ‰‹æœ­ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
            function displayHand(hand, handDiv, isPlayer) {
                handDiv.innerHTML = '';
                hand.forEach((card, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    cardDiv.innerText = choices[card];
                    cardDiv.dataset.choice = card;
                    if (isPlayer) {
                        cardDiv.addEventListener('click', () => selectCard(card, index));
                        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¢ã‚¯ã‚»ã‚¹å¯¾å¿œ
                        cardDiv.setAttribute('tabindex', '0');
                        cardDiv.setAttribute('role', 'button');
                        cardDiv.setAttribute('aria-pressed', 'false');
                        cardDiv.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                selectCard(card, index);
                            }
                        });
                    }
                    handDiv.appendChild(cardDiv);
                });
            }

            // ã‚«ãƒ¼ãƒ‰é¸æŠé–¢æ•°
            function selectCard(playerChoice, index) {
                if (playerSelected !== null) {
                    // æ—¢ã«é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯é¸æŠã‚’å¤‰æ›´
                    const prevSelectedCard = playerHandDiv.children[playerSelectedIndex];
                    if (prevSelectedCard) {
                        prevSelectedCard.classList.remove('selected');
                        prevSelectedCard.setAttribute('aria-pressed', 'false');
                    }
                }

                playerSelected = playerChoice;
                playerSelectedIndex = index;

                // æ–°ã—ãé¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆ
                const selectedCard = playerHandDiv.children[index];
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    selectedCard.setAttribute('aria-pressed', 'true');
                }

                // ã‚µã‚¦ãƒ³ãƒ‰ã‚’å†ç”Ÿ
                selectSound.currentTime = 0;
                selectSound.play().catch(error => {
                    console.error('é¸æŠéŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                });

                // æ–°ã—ã„ã‚µã‚¦ãƒ³ãƒ‰ã‚’å†ç”Ÿ
                choiceSound.currentTime = 0;
                choiceSound.play().catch(error => {
                    console.error('é¸æŠéŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                });

                // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                confirmButton.style.display = 'inline-block';
            }

            // ç¢ºå®šãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            confirmButton.addEventListener('click', () => {
                if (playerSelected === null || isNaN(currentBet) || currentBet <= 0) return;

                // AIãŒæˆ¦ç•¥çš„ã«é¸æŠ
                let aiChoice, aiIndex;
                ({ choice: aiChoice, index: aiIndex } = getAIStrategyChoice());

                let aiSelected = null;
                if (aiIndex !== -1 && aiChoice) {
                    aiSelected = aiChoice;
                    const aiCardDiv = aiHandDiv.children[aiIndex];
                    if (aiCardDiv) {
                        aiCardDiv.classList.add('selected');
                        // ã‚µã‚¦ãƒ³ãƒ‰ã‚’å†ç”Ÿ
                        selectSound.currentTime = 0;
                        selectSound.play().catch(error => {
                            console.error('AIé¸æŠéŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                        });
                    }
                } else {
                    // AIãŒæ‰‹ã‚’å‡ºã•ãªã„å ´åˆã®å¯¾ç­–
                    alert('AIãŒæ‰‹ã‚’å‡ºã›ã¾ã›ã‚“ã§ã—ãŸã€‚è‡ªå‹•çš„ã«æ‰‹ã‚’é¸æŠã—ã¾ã™ã€‚');
                    const fallbackChoice = getFallbackAIChoice();
                    if (fallbackChoice.choice && fallbackChoice.index !== -1) {
                        aiSelected = fallbackChoice.choice;
                        aiIndex = fallbackChoice.index; // å†å®£è¨€ã‚¨ãƒ©ãƒ¼ã‚’é˜²ããŸã‚ã«letã‚’ä½¿ç”¨
                        const fallbackCardDiv = aiHandDiv.children[fallbackChoice.index];
                        if (fallbackCardDiv) {
                            fallbackCardDiv.classList.add('selected');
                            // ã‚µã‚¦ãƒ³ãƒ‰ã‚’å†ç”Ÿ
                            selectSound.currentTime = 0;
                            selectSound.play().catch(error => {
                                console.error('AIãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯é¸æŠéŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                            });
                        }
                    } else {
                        // AIã®æ‰‹æœ­ãŒç©ºã®å ´åˆ
                        aiSelected = null;
                        aiIndex = -1;
                    }
                }

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠå±¥æ­´ã‚’æ›´æ–°
                updatePlayerHistory(playerSelected);

                // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                confirmButton.style.display = 'none';

                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’é–‹å§‹ï¼ˆaiIndexã‚’è¿½åŠ ï¼‰
                startCountdown(playerSelected, aiSelected, aiIndex);
            });

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã¨çµæœè¡¨ç¤ºã®é–¢æ•°
            function startCountdown(playerChoice, aiChoice, aiIndex) {
                // ç„¡åŠ¹åŒ–
                disableChoices();

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                messageDiv.innerHTML = '';

                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚’è¡¨ç¤º
                const countdownDiv = document.createElement('div');
                countdownDiv.id = 'countdown';
                countdownDiv.innerText = 'çµæœç™ºè¡¨â€¦';
                messageDiv.appendChild(countdownDiv);

                // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã‚¨ãƒ•ã‚§ã‚¯ãƒˆï¼ˆ1.5ç§’é–“ï¼‰
                setTimeout(() => {
                    revealChoices(playerChoice, aiChoice, aiIndex);
                }, 1500); // 1.5ç§’ã®é–“
            }

            // é¸æŠã‚’å…¬é–‹ã—çµæœã‚’åˆ¤å®šã™ã‚‹é–¢æ•°
            function revealChoices(playerChoice, aiChoice, aiIndex) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨AIã®é¸æŠã‚’è¡¨ç¤º
                playerChoiceIcon.innerText = choices[playerChoice];
                computerChoiceIcon.innerText = aiChoice ? choices[aiChoice] : '-';
                resultDisplay.style.display = 'flex';

                // å‹æ•—ã‚’åˆ¤å®š
                const result = determineWinner(playerChoice, aiChoice);

                // ã‚¹ã‚³ã‚¢ã‚’æ›´æ–°
                if (result.winner === 'player') {
                    // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒˆã‚’åŠ ç®—
                    const points = getPoints(playerChoice);
                    playerScore += points;
                    playerScoreSpan.innerText = playerScore;
                    winSound.play().catch(error => {
                        console.error('å‹åˆ©éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    });
                } else if (result.winner === 'computer') {
                    // AIã®é¸æŠã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒˆã‚’åŠ ç®—
                    const points = getPoints(aiChoice);
                    aiScore += points;
                    aiScoreSpan.innerText = aiScore;
                    loseSound.play().catch(error => {
                        console.error('æ•—åŒ—éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    });
                } else {
                    tieSound.play().catch(error => {
                        console.error('å¼•ãåˆ†ã‘éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    });
                }

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆå¤§ããä¸­å¤®ã«ï¼‰
                messageDiv.innerHTML = `<span style="font-size: 2em; font-weight: bold;">${result.message}</span>`;

                // ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®é©ç”¨
                if (result.winner === 'player') {
                    playerChoiceIcon.classList.add('winner');
                    computerChoiceIcon.classList.remove('winner');
                } else if (result.winner === 'computer') {
                    computerChoiceIcon.classList.add('winner');
                    playerChoiceIcon.classList.remove('winner');
                } else {
                    playerChoiceIcon.classList.remove('winner');
                    computerChoiceIcon.classList.remove('winner');
                    messageDiv.classList.remove('winner');
                }

                // ä½¿ç”¨æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã®å‰Šé™¤
                removeUsedCards(playerSelected, aiChoice, aiIndex);

                // ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’å¢—åŠ 
                roundCount++;

                if (roundCount >= maxRounds) {
                    finalizeGame();
                } else {
                    prepareNextRound();
                }
            }

            // ä½¿ç”¨æ¸ˆã¿ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹é–¢æ•°
            function removeUsedCards(playerChoice, aiChoice, aiIndex) {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠã‚’æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
                if (playerSelectedIndex !== null && playerHandDiv.children[playerSelectedIndex]) {
                    playerHand.splice(playerSelectedIndex, 1);
                    playerHandDiv.removeChild(playerHandDiv.children[playerSelectedIndex]);
                }

                // AIã®é¸æŠã‚’æ‰‹æœ­ã‹ã‚‰å‰Šé™¤
                if (aiChoice && aiIndex !== -1 && aiHandDiv.children[aiIndex]) {
                    aiHand.splice(aiIndex, 1);
                    aiHandDiv.removeChild(aiHandDiv.children[aiIndex]);
                }
            }

            // å‹æ•—ã‚’åˆ¤å®šã—ãƒã‚¤ãƒ³ãƒˆã‚’è¿”ã™é–¢æ•°
            function determineWinner(player, computer) {
                if (!computer) {
                    // AIãŒã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã§ããªã‹ã£ãŸå ´åˆã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã«1ç‚¹ã‚’ä»˜ä¸
                    return { winner: 'player', message: 'AIãŒã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚ãªãŸã«1ç‚¹ãŒä»˜ä¸ã•ã‚Œã¾ã—ãŸï¼', points: 1 };
                }

                if (player === computer) {
                    return { winner: 'tie', message: 'å¼•ãåˆ†ã‘ã§ã™ï¼', points: 0 };
                }

                if (
                    (player === 'rock' && computer === 'scissors') ||
                    (player === 'scissors' && computer === 'paper') ||
                    (player === 'paper' && computer === 'rock')
                ) {
                    return { winner: 'player', message: `ã‚ãªãŸã®${choices[player]}ãŒAIã®${choices[computer]}ã‚’æ‰“ã¡è² ã‹ã—ã¾ã—ãŸï¼`, points: getPoints(player) };
                } else {
                    return { winner: 'computer', message: `AIã®${choices[computer]}ãŒã‚ãªãŸã®${choices[player]}ã‚’æ‰“ã¡è² ã‹ã—ã¾ã—ãŸï¼`, points: getPoints(computer) };
                }
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¾ãŸã¯AIã®é¸æŠã«å¿œã˜ã¦ãƒã‚¤ãƒ³ãƒˆã‚’è¿”ã™é–¢æ•°
            function getPoints(choice) {
                switch(choice) {
                    case 'rock':
                        return 1;
                    case 'scissors':
                        return 2;
                    case 'paper':
                        return 5;
                    default:
                        return 0;
                }
            }

            // ã‚²ãƒ¼ãƒ ã‚’æœ€çµ‚åˆ¤å®šã™ã‚‹é–¢æ•°
            function finalizeGame() {
                let finalMessage = '';
                let goldChange = 0;
                if (playerScore > aiScore) {
                    finalMessage = `ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${playerScore} - AIã®ã‚¹ã‚³ã‚¢: ${aiScore}ã€‚ ã‚ãªãŸã®å‹ã¡ã§ã™ï¼ ğŸ‰`;
                    // è³­ã‘é‡‘ã®2å€ã‚’å ±é…¬ã¨ã—ã¦ä¸ãˆã‚‹
                    const reward = 2 * currentBet;
                    playerGold += reward;
                    playerGoldSpan.innerText = playerGold;
                    finalMessage += `<br>å ±é…¬ã¨ã—ã¦${reward}ã‚´ãƒ¼ãƒ«ãƒ‰ã‚’ç²å¾—ã—ã¾ã—ãŸï¼`;
                    rewardSound.play().catch(error => {
                        console.error('å ±é…¬éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    });
                    goldSound.play().catch(error => {
                        console.error('ã‚´ãƒ¼ãƒ«ãƒ‰éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    });
                    goldChange = reward;
                } else if (playerScore < aiScore) {
                    finalMessage = `ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${playerScore} - AIã®ã‚¹ã‚³ã‚¢: ${aiScore}ã€‚ AIã®å‹ã¡ã§ã™ï¼ ğŸ˜¢`;
                    if (isAllIn) { // å…¨é¡ãƒ™ãƒƒãƒˆæ™‚
                        goldChange = -playerGold;
                        playerGold = 0;
                    } else {
                        goldChange = -currentBet;
                        playerGold -= currentBet;
                    }
                    playerGoldSpan.innerText = playerGold;
                    loseSound.play().catch(error => {
                        console.error('æ•—åŒ—éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    });
                    goldSound.play().catch(error => {
                        console.error('ã‚´ãƒ¼ãƒ«ãƒ‰éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    });
                } else {
                    finalMessage = `ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${playerScore} - AIã®ã‚¹ã‚³ã‚¢: ${aiScore}ã€‚ å¼•ãåˆ†ã‘ã§ã™ï¼ ğŸ¤`;
                    goldChange = 0;
                }
                messageDiv.innerHTML = `<span style="font-size: 2em; font-weight: bold;">${finalMessage}</span>`;
                resetButton.style.display = 'inline-block';
                continueButton.style.display = 'inline-block'; // æ¬¡ã®ã‚²ãƒ¼ãƒ ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º

                // ã‚¹ã‚³ã‚¢ã¨ã‚´ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                const gameHistory = JSON.parse(localStorage.getItem('jankenGameHistory')) || [];
                gameHistory.push({
                    playerScore,
                    aiScore,
                    goldChange,
                    date: new Date().toLocaleString()
                });
                localStorage.setItem('jankenGameHistory', JSON.stringify(gameHistory));

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ã‚´ãƒ¼ãƒ«ãƒ‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                localStorage.setItem('playerGold', playerGold.toString());

                // é¸æŠãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
                disableChoices();
            }

            // æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ã®æº–å‚™ã‚’ã™ã‚‹é–¢æ•°
            function prepareNextRound() {
                // é¸æŠçµæœã‚’ãƒªã‚»ãƒƒãƒˆ
                playerChoiceIcon.innerText = '-';
                computerChoiceIcon.innerText = '-';
                resultDisplay.style.display = 'none';
                messageDiv.classList.remove('tie');

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨AIã®æ‰‹æœ­ã‚’å†è¡¨ç¤º
                displayHand(playerHand, playerHandDiv, true);
                displayHand(aiHand, aiHandDiv, false);

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
                playerSelected = null;
                playerSelectedIndex = null;

                // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
                messageDiv.innerText = 'æ¬¡ã®ãƒ©ã‚¦ãƒ³ãƒ‰ï¼ æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§ãã ã•ã„ã€‚';

                // é¸æŠãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                enableChoices();
            }

            // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            resetButton.addEventListener('click', () => {
                resetModal.style.display = 'flex';
            });

            // ãƒªã‚»ãƒƒãƒˆç¢ºèªãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            confirmResetButton.addEventListener('click', () => {
                // ãƒªã‚»ãƒƒãƒˆå‡¦ç†
                playerGold = 1000; // æ•°å€¤ã¨ã—ã¦è¨­å®š
                playerGoldSpan.innerText = playerGold;
                localStorage.setItem('playerGold', playerGold.toString()); // æ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜

                // ã‚²ãƒ¼ãƒ å±¥æ­´ã‚’å‰Šé™¤
                localStorage.removeItem('jankenGameHistory');
                localStorage.removeItem('playerHistory'); // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å±¥æ­´ã‚‚å‰Šé™¤

                // ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
                playerScore = 0;
                aiScore = 0;
                playerScoreSpan.innerText = playerScore;
                aiScoreSpan.innerText = aiScore;

                // é¸æŠçµæœã‚’ãƒªã‚»ãƒƒãƒˆ
                playerChoiceIcon.innerText = '-';
                computerChoiceIcon.innerText = '-';
                resultDisplay.style.display = 'none';
                messageDiv.classList.remove('tie');
                messageDiv.innerText = 'ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ã¾ã—ã‚‡ã†ï¼ å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§ãã ã•ã„ã€‚';

                // æ‰‹æœ­ã‚’å†ç”Ÿæˆ
                playerHand = generateHand();
                aiHand = generateHand();
                displayHand(playerHand, playerHandDiv, true);
                displayHand(aiHand, aiHandDiv, false);

                // ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                roundCount = 0;

                // å…¨é¡ãƒ™ãƒƒãƒˆãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                isAllIn = false;

                // currentBetã‚’ãƒªã‚»ãƒƒãƒˆ
                currentBet = 0;

                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã¨ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                resetButton.style.display = 'none';
                continueButton.style.display = 'none';

                // æ›ã‘é‡‘é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showBettingModal();

                // é¸æŠãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                enableChoices();

                // ãƒªã‚»ãƒƒãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’éè¡¨ç¤º
                resetModal.style.display = 'none';
            });

            // ãƒªã‚»ãƒƒãƒˆã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            cancelResetButton.addEventListener('click', () => {
                resetModal.style.display = 'none';
            });

            // ã‚²ãƒ¼ãƒ å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºé–¢æ•°
            function showHistory() {
                const gameHistory = JSON.parse(localStorage.getItem('jankenGameHistory')) || [];
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                // ã‚°ãƒ©ãƒ•ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
                const labels = [];
                const goldData = [];
                let cumulativeGold = 1000; // åˆæœŸã‚´ãƒ¼ãƒ«ãƒ‰

                gameHistory.forEach((game, index) => {
                    labels.push(`Game ${index + 1}`);
                    cumulativeGold += game.goldChange;
                    goldData.push(cumulativeGold);

                    // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã®ä½œæˆ
                    const listItem = document.createElement('li');
                    let historyText = `${index + 1}. æ—¥æ™‚: ${game.date}, ã‚ãªãŸã®ã‚¹ã‚³ã‚¢: ${game.playerScore} - AIã®ã‚¹ã‚³ã‚¢: ${game.aiScore}`;
                    if (game.goldChange > 0) {
                        historyText += `, ã‚´ãƒ¼ãƒ«ãƒ‰ç²å¾—: +${game.goldChange}ã‚´ãƒ¼ãƒ«ãƒ‰`;
                    } else if (game.goldChange < 0) {
                        historyText += `, ã‚´ãƒ¼ãƒ«ãƒ‰æ¸›å°‘: ${game.goldChange}ã‚´ãƒ¼ãƒ«ãƒ‰`;
                    } else {
                        historyText += `, ã‚´ãƒ¼ãƒ«ãƒ‰å¤‰å‹•ãªã—`;
                    }
                    listItem.innerHTML = historyText;
                    historyList.appendChild(listItem);
                });

                // ã‚°ãƒ©ãƒ•ã®æç”»
                const ctx = document.getElementById('history-chart').getContext('2d');
                if (window.historyChart instanceof Chart) {
                    window.historyChart.destroy();
                }
                window.historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'æ‰€æŒé‡‘ã®æ¨ç§»',
                            data: goldData,
                            borderColor: 'rgba(255, 215, 0, 1)',
                            backgroundColor: 'rgba(255, 215, 0, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false, // ãƒã‚¤ãƒŠã‚¹ã‚‚è¡¨ç¤ºã§ãã‚‹ã‚ˆã†ã«
                                suggestedMin: Math.min(...goldData, 0) - 5000,
                                suggestedMax: Math.max(...goldData) + 5000,
                                title: {
                                    display: true,
                                    text: 'ã‚´ãƒ¼ãƒ«ãƒ‰'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ã‚²ãƒ¼ãƒ æ•°'
                                }
                            }
                        }
                    }
                });

                // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                historyModal.style.display = 'flex';
            }

            // ã‚²ãƒ¼ãƒ å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰é–ã‚¤ãƒ™ãƒ³ãƒˆ
            closeHistory.addEventListener('click', () => {
                historyModal.style.display = 'none';
            });

            // æ›ã‘é‡‘é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºé–¢æ•°
            function showBettingModal() {
                // currentBetã‚’ãƒªã‚»ãƒƒãƒˆ
                currentBet = 0;
                bettingModal.style.display = 'flex';

                // ã€Œå…¨é¡ãƒ™ãƒƒãƒˆã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
                const allInButton = document.querySelector('.bet-button[data-bet="all-in"]');
                if (playerGold > 0) {
                    allInButton.style.display = 'inline-block';
                } else {
                    allInButton.style.display = 'none';
                }
            }

            // æ›ã‘é‡‘é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã®é–‰é–ã‚¤ãƒ™ãƒ³ãƒˆ
            closeBetting.addEventListener('click', () => {
                // ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã—ãªã„å ´åˆã€ãƒªãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã‹åˆ¥ã®å‡¦ç†ã‚’è¡Œã†
                bettingModal.style.display = 'none';
                alert('æ›ã‘é‡‘ã‚’é¸æŠã—ãªã„å ´åˆã€ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            });

            // æ›ã‘é‡‘é¸æŠãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            bettingButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedBetData = button.dataset.bet;
                    let selectedBet;

                    if (selectedBetData === 'all-in') {
                        selectedBet = playerGold;
                        if (playerGold <= 0) {
                            alert('æ‰€æŒé‡‘ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ›ã‘é‡‘ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
                            return;
                        }
                        isAllIn = true; // å…¨é¡ãƒ™ãƒƒãƒˆãƒ•ãƒ©ã‚°ã‚’è¨­å®š
                    } else {
                        selectedBet = parseInt(selectedBetData, 10);
                        if (isNaN(selectedBet)) {
                            alert('ç„¡åŠ¹ãªæ›ã‘é‡‘ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚');
                            return;
                        }
                        // æ‰€æŒé‡‘ãŒæ›ã‘é‡‘ã‚ˆã‚Šå°‘ãªã„å ´åˆã§ã‚‚é¸æŠå¯èƒ½
                        // ãŸã ã—ã€ã€Œå…¨é¡ãƒ™ãƒƒãƒˆã€ã¯åˆ¥é€”åˆ¶å¾¡
                        if (selectedBet > playerGold) {
                            alert(`æ‰€æŒé‡‘ãŒä¸è¶³ã—ã¦ã„ã¾ã™ã€‚æ‰€æŒé‡‘: ${playerGold}ã‚´ãƒ¼ãƒ«ãƒ‰`);
                            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ‰€æŒé‡‘ãŒãƒã‚¤ãƒŠã‚¹ã®å ´åˆã§ã‚‚é¸æŠå¯èƒ½
                            // ã“ã“ã§ã¯æ›ã‘é‡‘ã‚’å¼•ãè½ã¨ã™
                            // No return; allow the bet
                        }
                        isAllIn = false; // å…¨é¡ãƒ™ãƒƒãƒˆã§ã¯ãªã„
                    }

                    currentBet = selectedBet;

                    // æ›ã‘é‡‘ãŒæ­£ã®æ•°ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                    if (currentBet <= 0 || isNaN(currentBet)) {
                        alert('ç„¡åŠ¹ãªæ›ã‘é‡‘ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚');
                        return;
                    }

                    // æ‰€æŒé‡‘ã‹ã‚‰æ›ã‘é‡‘ã‚’å¼•ãè½ã¨ã™
                    playerGold -= currentBet;
                    playerGoldSpan.innerText = playerGold;
                    localStorage.setItem('playerGold', playerGold.toString()); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜

                    // gold.mp3 ã®ã‚µã‚¦ãƒ³ãƒ‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’å†ç”Ÿ
                    goldSound.currentTime = 0;
                    goldSound.play().catch(error => {
                        console.error('ã‚´ãƒ¼ãƒ«ãƒ‰éŸ³å£°ã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                    });

                    bettingModal.style.display = 'none';
                    messageDiv.innerText = `æ›ã‘é‡‘: ${currentBet}ã‚´ãƒ¼ãƒ«ãƒ‰ã‚’æ”¯æ‰•ã„ã¾ã—ãŸã€‚æ‰‹æœ­ã‹ã‚‰1æšé¸ã‚“ã§ãã ã•ã„ã€‚`;
                });
            });

            // ã€Œæ¬¡ã®ã‚²ãƒ¼ãƒ ã‚’ç¶šã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            continueButton.addEventListener('click', () => {
                // ã‚¹ã‚³ã‚¢ã‚’ãƒªã‚»ãƒƒãƒˆ
                playerScore = 0;
                aiScore = 0;
                playerScoreSpan.innerText = playerScore;
                aiScoreSpan.innerText = aiScore;

                // é¸æŠçµæœã‚’ãƒªã‚»ãƒƒãƒˆ
                playerChoiceIcon.innerText = '-';
                computerChoiceIcon.innerText = '-';
                resultDisplay.style.display = 'none';
                messageDiv.classList.remove('tie');

                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¨AIã®æ‰‹æœ­ã‚’å†ç”Ÿæˆ
                playerHand = generateHand();
                aiHand = generateHand();
                displayHand(playerHand, playerHandDiv, true);
                displayHand(aiHand, aiHandDiv, false);

                // ãƒ©ã‚¦ãƒ³ãƒ‰æ•°ã‚’ãƒªã‚»ãƒƒãƒˆ
                roundCount = 0;

                // å…¨é¡ãƒ™ãƒƒãƒˆãƒ•ãƒ©ã‚°ã‚’ãƒªã‚»ãƒƒãƒˆ
                isAllIn = false;

                // currentBetã‚’ãƒªã‚»ãƒƒãƒˆ
                currentBet = 0;

                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã¨ç¶šã‘ã‚‹ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
                resetButton.style.display = 'none';
                continueButton.style.display = 'none';

                // æ›ã‘é‡‘é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showBettingModal();

                // é¸æŠãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
                enableChoices();
            });

            // AIã®æˆ¦ç•¥çš„ãªé¸æŠé–¢æ•°
            function getAIStrategyChoice() {
                // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠå±¥æ­´ã‚’å–å¾—
                const history = JSON.parse(localStorage.getItem('playerHistory')) || { rock: 0, paper: 0, scissors: 0 };
                const mostChosen = Object.keys(history).reduce((a, b) => history[a] > history[b] ? a : b, 'rock');

                // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’é¸æŠ
                let counter;
                switch (mostChosen) {
                    case 'rock':
                        counter = 'paper';
                        break;
                    case 'paper':
                        counter = 'scissors';
                        break;
                    case 'scissors':
                        counter = 'rock';
                        break;
                    default:
                        counter = getRandomChoice();
                }

                // AIã®æ‰‹æœ­ã«ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
                const matchingIndices = [];
                aiHand.forEach((choice, index) => {
                    if (choice === counter) {
                        matchingIndices.push(index);
                    }
                });

                if (matchingIndices.length > 0) {
                    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                    const randomIndex = matchingIndices[Math.floor(Math.random() * matchingIndices.length)];
                    return { choice: counter, index: randomIndex };
                } else {
                    // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                    const randomChoice = getRandomChoice();
                    const randomIndices = [];
                    aiHand.forEach((choice, index) => {
                        if (choice === randomChoice) {
                            randomIndices.push(index);
                        }
                    });
                    if (randomIndices.length > 0) {
                        const randomIndex = randomIndices[Math.floor(Math.random() * randomIndices.length)];
                        return { choice: randomChoice, index: randomIndex };
                    } else {
                        // AIã®æ‰‹æœ­ãŒç©ºã®å ´åˆ
                        return { choice: null, index: -1 };
                    }
                }
            }

            // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯AIé¸æŠé–¢æ•°ï¼ˆAIãŒæ‰‹ã‚’å‡ºã•ãªã„å ´åˆã«å‘¼ã³å‡ºã™ï¼‰
            function getFallbackAIChoice() {
                if (aiHand.length === 0) {
                    return { choice: null, index: -1 };
                }
                // ä½•ã‚‰ã‹ã®ç†ç”±ã§AIãŒé¸æŠã—ãªã‹ã£ãŸå ´åˆã€ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                const randomIndex = Math.floor(Math.random() * aiHand.length);
                return { choice: aiHand[randomIndex], index: randomIndex };
            }

            // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã™ã‚‹é–¢æ•°
            function getRandomChoice() {
                const options = ['rock', 'paper', 'scissors'];
                return options[Math.floor(Math.random() * options.length)];
            }

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¸æŠå±¥æ­´ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
            function updatePlayerHistory(playerChoice) {
                const history = JSON.parse(localStorage.getItem('playerHistory')) || { rock: 0, paper: 0, scissors: 0 };
                if (history.hasOwnProperty(playerChoice)) {
                    history[playerChoice]++;
                } else {
                    history[playerChoice] = 1;
                }
                localStorage.setItem('playerHistory', JSON.stringify(history));
            }

            // ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–é–¢æ•°
            function init() {
                // åˆæœŸæ‰‹æœ­ç”Ÿæˆ
                playerHand = generateHand();
                aiHand = generateHand();
                displayHand(playerHand, playerHandDiv, true);
                displayHand(aiHand, aiHandDiv, false);

                // åˆæœŸã‚´ãƒ¼ãƒ«ãƒ‰ã®è¨­å®š
                const storedGold = localStorage.getItem('playerGold');
                if (storedGold !== null) {
                    playerGold = parseInt(storedGold, 10);
                    if (isNaN(playerGold)) { // NaNãƒã‚§ãƒƒã‚¯
                        playerGold = 1000;
                        localStorage.setItem('playerGold', playerGold.toString());
                    }
                } else {
                    playerGold = 1000;
                    localStorage.setItem('playerGold', playerGold.toString());
                }
                playerGoldSpan.innerText = playerGold;

                // UIã®åˆæœŸåŒ–
                setupUI();

                // æ›ã‘é‡‘é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                showBettingModal();

                // BGMã®å†ç”Ÿè¨±å¯
                window.addEventListener('click', () => {
                    if (bgm.paused) {
                        bgm.play().catch(error => {
                            console.error('BGMã®å†ç”Ÿã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
                        });
                    }
                }, { once: true });
            }

            // UIã®åˆæœŸåŒ–é–¢æ•°
            function setupUI() {
                // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã¯æ—¢ã«ã‚«ãƒ¼ãƒ‰ã«è¿½åŠ æ¸ˆã¿
                // ä»–ã®UIé–¢é€£ã®åˆæœŸåŒ–ãŒã‚ã‚Œã°ã“ã“ã«è¿½åŠ 
                historyButton.addEventListener('click', showHistory);

                // ãƒŸãƒ¥ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½è¿½åŠ 
                muteButton.addEventListener('click', () => {
                    if (bgm.muted) {
                        bgm.muted = false;
                        muteButton.innerText = 'ãƒŸãƒ¥ãƒ¼ãƒˆ';
                    } else {
                        bgm.muted = true;
                        muteButton.innerText = 'éŸ³å£°ã‚ªãƒ³';
                    }
                });
            }

            // ã‚²ãƒ¼ãƒ ã®åˆæœŸåŒ–
            init();

            // é¸æŠãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–ã™ã‚‹é–¢æ•°
            function disableChoices() {
                const cards = playerHandDiv.getElementsByClassName('card');
                for (let card of cards) {
                    card.style.cursor = 'not-allowed';
                    card.style.opacity = '0.6';
                }
            }

            // é¸æŠãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–ã™ã‚‹é–¢æ•°
            function enableChoices() {
                const cards = playerHandDiv.getElementsByClassName('card');
                for (let card of cards) {
                    card.style.cursor = 'pointer';
                    card.style.opacity = '1';
                }
            }
        })();
    </script>
</body>
</html>
