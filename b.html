<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>スコア付き限定じゃんけんゲーム</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* リセットCSS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: Arial, sans-serif;
            background-image: url('assets/images/janken_background_img.webp');
            background-size: cover;
            background-position: center;
            color: #fff;
            text-align: center;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        h1 {
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px #000;
        }

        #game-container {
            display: flex;
            justify-content: space-around;
            align-items: center;
            flex-wrap: wrap;
            margin-bottom: 20px;
            width: 100%;
        }

        .side {
            width: 45%;
            min-width: 300px;
        }

        .character-placeholder {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 1.5em;
            box-shadow: 2px 2px 10px #000;
        }

        .hand {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .card {
            width: 60px;
            height: 60px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 2px solid #fff;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s;
        }

        .card:hover {
            transform: scale(1.1);
            border-color: #ffd700;
        }

        .selected {
            border-color: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.9);
            animation: rotate 0.5s linear;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        #confirm-button, #reset-button, #continue-button, #mute-button, #history-button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 1em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        #confirm-button {
            background-color: #28a745;
            color: #fff;
        }

        #confirm-button:hover {
            background-color: #218838;
        }

        #reset-button {
            background-color: #dc3545;
            color: #fff;
            display: none;
        }

        #reset-button:hover {
            background-color: #c82333;
        }

        #continue-button {
            background-color: #007bff;
            color: #fff;
            display: none;
        }

        #continue-button:hover {
            background-color: #0069d9;
        }

        #mute-button {
            background-color: #17a2b8;
            color: #fff;
            position: absolute;
            top: 20px;
            right: 20px;
        }

        #mute-button:hover {
            background-color: #138496;
        }

        #history-button {
            background-color: #6c757d;
            color: #fff;
        }

        #history-button:hover {
            background-color: #5a6268;
        }

        #message {
            margin-bottom: 20px;
            font-size: 1.5em;
            min-height: 2em;
            text-shadow: 1px 1px 2px #000;
            background-color: rgba(0, 0, 0, 0.6);
            padding: 10px;
            border-radius: 10px;
            max-width: 600px;
            margin: 0 auto 20px auto;
        }

        .result {
            display: none;
            justify-content: center;
            gap: 50px;
            margin-bottom: 20px;
        }

        .result-icon {
            font-size: 3em;
        }

        .winner {
            animation: fadeIn 1s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        #scoreboard {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 50px;
            margin-bottom: 20px;
            font-size: 1.2em;
            text-shadow: 1px 1px 2px #000;
        }

        .score {
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 2px 2px 10px #000;
        }

        /* ゴールド表示 */
        .gold {
            background-color: rgba(255, 215, 0, 0.8);
            color: #000;
            padding: 10px 20px;
            border-radius: 10px;
            box-shadow: 2px 2px 10px #000;
            font-weight: bold;
            order: -1;
        }

        /* モーダルスタイル */
        #history-modal, #betting-modal, #reset-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #history-content, #betting-content, #reset-content {
            background-color: #333;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 800px;
            color: #f0f0f0;
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        #close-history, #close-betting, #close-reset {
            position: absolute;
            top: 10px;
            right: 20px;
            cursor: pointer;
            font-size: 24px;
        }

        #history-list {
            list-style: none;
            text-align: left;
            margin-top: 20px;
        }

        /* 掛け金ボタン */
        .bet-button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 1.2em;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            background-color: #ffc107;
            color: #000;
        }

        .bet-button:hover {
            background-color: #e0a800;
        }

        /* リセットモーダルのスタイル */
        #reset-content p {
            margin: 20px 0;
            font-size: 1.2em;
        }

        /* グラフのスタイル */
        #history-chart {
            max-width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        /* タッチデバイス向けのスタイル */
        @media (max-width: 800px) {
            .card {
                width: 70px;
                height: 70px;
                font-size: 2.2em;
            }

            #confirm-button, #reset-button, #continue-button, #mute-button, #history-button {
                width: 100%;
                padding: 12px;
                font-size: 1.2em;
            }

            #scoreboard {
                flex-direction: column;
                gap: 20px;
            }

            #message {
                font-size: 1.2em;
            }

            #history-chart {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <!-- ミュートボタンを右上に配置 -->
    <button id="mute-button">ミュート</button>

    <!-- 背景音楽 -->
    <audio id="bgm" src="assets/sounds/janken_bgm.mp3" autoplay loop></audio>

    <h1>スコア付き限定じゃんけんゲーム</h1>
    <div id="game-container">
        <!-- プレイヤーエリア -->
        <div class="side">
            <div class="character-placeholder" id="player-character">
                プレイヤー
            </div>
            <div class="hand" id="player-hand">
                <!-- プレイヤーの手札が表示されます -->
            </div>
            <button id="confirm-button" style="display: none;">確定</button>
        </div>
        <!-- AIエリア -->
        <div class="side">
            <div class="character-placeholder" id="ai-character">
                AI
            </div>
            <div class="hand" id="ai-hand">
                <!-- AIの手札が表示されます -->
            </div>
        </div>
    </div>
    <div id="message">
        ゲームを開始しましょう！ 各プレイヤーは手札から1枚選んでください。
    </div>
    <div class="result" id="result-display">
        <div class="player">
            <h3>あなたの選択</h3>
            <span class="result-icon" id="player-choice-icon">-</span>
        </div>
        <div class="computer">
            <h3>AIの選択</h3>
            <span class="result-icon" id="computer-choice-icon">-</span>
        </div>
    </div>
    <div id="scoreboard">
        <div class="gold">所持金: <span id="player-gold">1000</span>ゴールド</div>
        <div class="score">あなたのスコア: <span id="player-score">0</span></div>
        <div class="score">AIのスコア: <span id="ai-score">0</span></div>
    </div>
    <button id="reset-button" style="display: none;">リセット</button>
    <button id="continue-button" style="display: none;">次のゲームを続ける</button>
    <button id="history-button">ゲーム履歴</button>

    <!-- サウンドエフェクト -->
    <audio id="choice-sound" src="assets/sounds/choice.mp3"></audio>
    <audio id="gold-sound" src="assets/sounds/gold.mp3"></audio>
    <audio id="select-sound" src="assets/sounds/select.mp3"></audio>
    <audio id="win-sound" src="assets/sounds/win.mp3"></audio>
    <audio id="lose-sound" src="assets/sounds/lose.mp3"></audio>
    <audio id="tie-sound" src="assets/sounds/tie.mp3"></audio>
    <audio id="reward-sound" src="assets/sounds/reward.mp3"></audio>

    <!-- ゲーム履歴モーダル -->
    <div id="history-modal">
        <div id="history-content">
            <span id="close-history">&times;</span>
            <h2>ゲーム履歴</h2>
            <canvas id="history-chart"></canvas>
            <ul id="history-list"></ul>
        </div>
    </div>

    <!-- 掛け金選択モーダル -->
    <div id="betting-modal">
        <div id="betting-content">
            <span id="close-betting">&times;</span>
            <h2>掛け金を選択してください</h2>
            <button class="bet-button" data-bet="100">100ゴールド</button>
            <button class="bet-button" data-bet="300">300ゴールド</button>
            <button class="bet-button" data-bet="500">500ゴールド</button>
            <button class="bet-button" data-bet="1000">1000ゴールド</button>
            <button class="bet-button" data-bet="all-in">全額ベット</button>
        </div>
    </div>

    <!-- リセット確認モーダル -->
    <div id="reset-modal">
        <div id="reset-content">
            <span id="close-reset">&times;</span>
            <h2>ゲームをリセットしますか？</h2>
            <p>リセットすると所持金が1000ゴールドに戻り、ゲーム履歴が削除されます。よろしいですか？</p>
            <button id="confirm-reset-button" class="bet-button">はい</button>
            <button id="cancel-reset-button" class="bet-button">いいえ</button>
        </div>
    </div>

    <!-- JavaScriptの統合 -->
    <script>
        // ゲームモジュールの定義
        const GameModule = (() => {
            // 選択肢の定義
            const choices = {
                'rock': '✊',
                'paper': '✋',
                'scissors': '✌️'
            };

            // スコア変数
            let playerScore = 0;
            let aiScore = 0;

            // ゴールド変数
            let playerGold = 1000;

            // 掛け金
            let currentBet = 0;

            // 手札
            let playerHand = [];
            let aiHand = [];

            // プレイヤーの選択
            let playerSelected = null;
            let playerSelectedIndex = null;

            // ラウンド数
            let roundCount = 0;
            const maxRounds = 5;

            // フラグ: 全額ベットかどうか
            let isAllIn = false;

            // DOM要素の取得
            const confirmButton = document.getElementById('confirm-button');
            const resetButton = document.getElementById('reset-button');
            const continueButton = document.getElementById('continue-button');
            const muteButton = document.getElementById('mute-button');
            const historyButton = document.getElementById('history-button');

            const messageDiv = document.getElementById('message');
            const resultDisplay = document.getElementById('result-display');
            const playerChoiceIcon = document.getElementById('player-choice-icon');
            const computerChoiceIcon = document.getElementById('computer-choice-icon');

            const playerHandDiv = document.getElementById('player-hand');
            const aiHandDiv = document.getElementById('ai-hand');

            const playerScoreSpan = document.getElementById('player-score');
            const aiScoreSpan = document.getElementById('ai-score');
            const playerGoldSpan = document.getElementById('player-gold'); // ゴールド表示

            const bgm = document.getElementById('bgm');

            // サウンドエレメントの取得
            const choiceSound = document.getElementById('choice-sound');
            const goldSound = document.getElementById('gold-sound');
            const selectSound = document.getElementById('select-sound');
            const winSound = document.getElementById('win-sound');
            const loseSound = document.getElementById('lose-sound');
            const tieSound = document.getElementById('tie-sound');
            const rewardSound = document.getElementById('reward-sound'); // 新規取得

            // モーダル要素の取得
            const bettingModal = document.getElementById('betting-modal');
            const bettingContent = document.getElementById('betting-content');
            const closeBetting = document.getElementById('close-betting');
            const bettingButtons = document.querySelectorAll('.bet-button');

            const historyModal = document.getElementById('history-modal');
            const historyContent = document.getElementById('history-content');
            const closeHistory = document.getElementById('close-history');

            const resetModal = document.getElementById('reset-modal');
            const resetContent = document.getElementById('reset-content');
            const closeReset = document.getElementById('close-reset');
            const confirmResetButton = document.getElementById('confirm-reset-button');
            const cancelResetButton = document.getElementById('cancel-reset-button');

            // 初期手札生成関数
            function generateHand() {
                const hand = [];
                const options = ['rock', 'paper', 'scissors'];
                for (let i = 0; i < 5; i++) {
                    const randomChoice = options[Math.floor(Math.random() * options.length)];
                    hand.push(randomChoice);
                }
                return hand;
            }

            // 手札を表示する関数
            function displayHand(hand, handDiv, isPlayer) {
                handDiv.innerHTML = '';
                hand.forEach((card, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    cardDiv.innerText = choices[card];
                    cardDiv.dataset.choice = card;
                    if (isPlayer) {
                        cardDiv.addEventListener('click', () => selectCard(card, index));
                        // キーボードアクセス対応
                        cardDiv.setAttribute('tabindex', '0');
                        cardDiv.setAttribute('role', 'button');
                        cardDiv.setAttribute('aria-pressed', 'false');
                        cardDiv.addEventListener('keypress', (e) => {
                            if (e.key === 'Enter' || e.key === ' ') {
                                selectCard(card, index);
                            }
                        });
                    }
                    handDiv.appendChild(cardDiv);
                });
            }

            // カード選択関数
            function selectCard(playerChoice, index) {
                if (playerSelected !== null) {
                    // 既に選択されている場合は選択を変更
                    const prevSelectedCard = playerHandDiv.children[playerSelectedIndex];
                    if (prevSelectedCard) {
                        prevSelectedCard.classList.remove('selected');
                        prevSelectedCard.setAttribute('aria-pressed', 'false');
                    }
                }

                playerSelected = playerChoice;
                playerSelectedIndex = index;

                // 新しく選択されたカードにハイライト
                const selectedCard = playerHandDiv.children[index];
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                    selectedCard.setAttribute('aria-pressed', 'true');
                }

                // サウンドを再生
                selectSound.currentTime = 0;
                selectSound.play().catch(error => {
                    console.error('選択音声の再生に失敗しました:', error);
                });

                // 新しいサウンドを再生
                choiceSound.currentTime = 0;
                choiceSound.play().catch(error => {
                    console.error('選択音声の再生に失敗しました:', error);
                });

                // 確定ボタンを表示
                confirmButton.style.display = 'inline-block';
            }

            // 確定ボタンのクリックイベント
            confirmButton.addEventListener('click', () => {
                if (playerSelected === null || isNaN(currentBet) || currentBet <= 0) return;

                // AIが戦略的に選択
                let aiChoice, aiIndex;
                ({ choice: aiChoice, index: aiIndex } = getAIStrategyChoice());

                let aiSelected = null;
                if (aiIndex !== -1 && aiChoice) {
                    aiSelected = aiChoice;
                    const aiCardDiv = aiHandDiv.children[aiIndex];
                    if (aiCardDiv) {
                        aiCardDiv.classList.add('selected');
                        // サウンドを再生
                        selectSound.currentTime = 0;
                        selectSound.play().catch(error => {
                            console.error('AI選択音声の再生に失敗しました:', error);
                        });
                    }
                } else {
                    // AIが手を出さない場合の対策
                    alert('AIが手を出せませんでした。自動的に手を選択します。');
                    const fallbackChoice = getFallbackAIChoice();
                    if (fallbackChoice.choice && fallbackChoice.index !== -1) {
                        aiSelected = fallbackChoice.choice;
                        aiIndex = fallbackChoice.index; // 再宣言エラーを防ぐためにletを使用
                        const fallbackCardDiv = aiHandDiv.children[fallbackChoice.index];
                        if (fallbackCardDiv) {
                            fallbackCardDiv.classList.add('selected');
                            // サウンドを再生
                            selectSound.currentTime = 0;
                            selectSound.play().catch(error => {
                                console.error('AIフォールバック選択音声の再生に失敗しました:', error);
                            });
                        }
                    } else {
                        // AIの手札が空の場合
                        aiSelected = null;
                        aiIndex = -1;
                    }
                }

                // プレイヤーの選択履歴を更新
                updatePlayerHistory(playerSelected);

                // 確定ボタンを非表示
                confirmButton.style.display = 'none';

                // カウントダウンを開始（aiIndexを追加）
                startCountdown(playerSelected, aiSelected, aiIndex);
            });

            // カウントダウンと結果表示の関数
            function startCountdown(playerChoice, aiChoice, aiIndex) {
                // 無効化
                disableChoices();

                // メッセージをクリア
                messageDiv.innerHTML = '';

                // カウントダウンを表示
                const countdownDiv = document.createElement('div');
                countdownDiv.id = 'countdown';
                countdownDiv.innerText = '結果発表…';
                messageDiv.appendChild(countdownDiv);

                // カウントダウンエフェクト（1.5秒間）
                setTimeout(() => {
                    revealChoices(playerChoice, aiChoice, aiIndex);
                }, 1500); // 1.5秒の間
            }

            // 選択を公開し結果を判定する関数
            function revealChoices(playerChoice, aiChoice, aiIndex) {
                // プレイヤーとAIの選択を表示
                playerChoiceIcon.innerText = choices[playerChoice];
                computerChoiceIcon.innerText = aiChoice ? choices[aiChoice] : '-';
                resultDisplay.style.display = 'flex';

                // 勝敗を判定
                const result = determineWinner(playerChoice, aiChoice);

                // スコアを更新
                if (result.winner === 'player') {
                    // プレイヤーの選択に応じてポイントを加算
                    const points = getPoints(playerChoice);
                    playerScore += points;
                    playerScoreSpan.innerText = playerScore;
                    winSound.play().catch(error => {
                        console.error('勝利音声の再生に失敗しました:', error);
                    });
                } else if (result.winner === 'computer') {
                    // AIの選択に応じてポイントを加算
                    const points = getPoints(aiChoice);
                    aiScore += points;
                    aiScoreSpan.innerText = aiScore;
                    loseSound.play().catch(error => {
                        console.error('敗北音声の再生に失敗しました:', error);
                    });
                } else {
                    tieSound.play().catch(error => {
                        console.error('引き分け音声の再生に失敗しました:', error);
                    });
                }

                // メッセージを表示（大きく中央に）
                messageDiv.innerHTML = `<span style="font-size: 2em; font-weight: bold;">${result.message}</span>`;

                // エフェクトの適用
                if (result.winner === 'player') {
                    playerChoiceIcon.classList.add('winner');
                    computerChoiceIcon.classList.remove('winner');
                } else if (result.winner === 'computer') {
                    computerChoiceIcon.classList.add('winner');
                    playerChoiceIcon.classList.remove('winner');
                } else {
                    playerChoiceIcon.classList.remove('winner');
                    computerChoiceIcon.classList.remove('winner');
                    messageDiv.classList.remove('winner');
                }

                // 使用済みカードの削除
                removeUsedCards(playerSelected, aiChoice, aiIndex);

                // ラウンド数を増加
                roundCount++;

                if (roundCount >= maxRounds) {
                    finalizeGame();
                } else {
                    prepareNextRound();
                }
            }

            // 使用済みカードを削除する関数
            function removeUsedCards(playerChoice, aiChoice, aiIndex) {
                // プレイヤーの選択を手札から削除
                if (playerSelectedIndex !== null && playerHandDiv.children[playerSelectedIndex]) {
                    playerHand.splice(playerSelectedIndex, 1);
                    playerHandDiv.removeChild(playerHandDiv.children[playerSelectedIndex]);
                }

                // AIの選択を手札から削除
                if (aiChoice && aiIndex !== -1 && aiHandDiv.children[aiIndex]) {
                    aiHand.splice(aiIndex, 1);
                    aiHandDiv.removeChild(aiHandDiv.children[aiIndex]);
                }
            }

            // 勝敗を判定しポイントを返す関数
            function determineWinner(player, computer) {
                if (!computer) {
                    // AIがカードを選択できなかった場合、プレイヤーに1点を付与
                    return { winner: 'player', message: 'AIがカードを選択できませんでした。あなたに1点が付与されました！', points: 1 };
                }

                if (player === computer) {
                    return { winner: 'tie', message: '引き分けです！', points: 0 };
                }

                if (
                    (player === 'rock' && computer === 'scissors') ||
                    (player === 'scissors' && computer === 'paper') ||
                    (player === 'paper' && computer === 'rock')
                ) {
                    return { winner: 'player', message: `あなたの${choices[player]}がAIの${choices[computer]}を打ち負かしました！`, points: getPoints(player) };
                } else {
                    return { winner: 'computer', message: `AIの${choices[computer]}があなたの${choices[player]}を打ち負かしました！`, points: getPoints(computer) };
                }
            }

            // プレイヤーまたはAIの選択に応じてポイントを返す関数
            function getPoints(choice) {
                switch(choice) {
                    case 'rock':
                        return 1;
                    case 'scissors':
                        return 2;
                    case 'paper':
                        return 5;
                    default:
                        return 0;
                }
            }

            // ゲームを最終判定する関数
            function finalizeGame() {
                let finalMessage = '';
                let goldChange = 0;
                if (playerScore > aiScore) {
                    finalMessage = `ゲーム終了！ あなたのスコア: ${playerScore} - AIのスコア: ${aiScore}。 あなたの勝ちです！ 🎉`;
                    // 賭け金の2倍を報酬として与える
                    const reward = 2 * currentBet;
                    playerGold += reward;
                    playerGoldSpan.innerText = playerGold;
                    finalMessage += `<br>報酬として${reward}ゴールドを獲得しました！`;
                    rewardSound.play().catch(error => {
                        console.error('報酬音声の再生に失敗しました:', error);
                    });
                    goldSound.play().catch(error => {
                        console.error('ゴールド音声の再生に失敗しました:', error);
                    });
                    goldChange = reward;
                } else if (playerScore < aiScore) {
                    finalMessage = `ゲーム終了！ あなたのスコア: ${playerScore} - AIのスコア: ${aiScore}。 AIの勝ちです！ 😢`;
                    if (isAllIn) { // 全額ベット時
                        goldChange = -playerGold;
                        playerGold = 0;
                    } else {
                        goldChange = -currentBet;
                        playerGold -= currentBet;
                    }
                    playerGoldSpan.innerText = playerGold;
                    loseSound.play().catch(error => {
                        console.error('敗北音声の再生に失敗しました:', error);
                    });
                    goldSound.play().catch(error => {
                        console.error('ゴールド音声の再生に失敗しました:', error);
                    });
                } else {
                    finalMessage = `ゲーム終了！ あなたのスコア: ${playerScore} - AIのスコア: ${aiScore}。 引き分けです！ 🤝`;
                    goldChange = 0;
                }
                messageDiv.innerHTML = `<span style="font-size: 2em; font-weight: bold;">${finalMessage}</span>`;
                resetButton.style.display = 'inline-block';
                continueButton.style.display = 'inline-block'; // 次のゲームボタンを表示

                // スコアとゴールドをローカルストレージに保存
                const gameHistory = JSON.parse(localStorage.getItem('jankenGameHistory')) || [];
                gameHistory.push({
                    playerScore,
                    aiScore,
                    goldChange,
                    date: new Date().toLocaleString()
                });
                localStorage.setItem('jankenGameHistory', JSON.stringify(gameHistory));

                // プレイヤーのゴールドをローカルストレージに保存
                localStorage.setItem('playerGold', playerGold.toString());

                // 選択ボタンを無効化
                disableChoices();
            }

            // 次のラウンドの準備をする関数
            function prepareNextRound() {
                // 選択結果をリセット
                playerChoiceIcon.innerText = '-';
                computerChoiceIcon.innerText = '-';
                resultDisplay.style.display = 'none';
                messageDiv.classList.remove('tie');

                // プレイヤーとAIの手札を再表示
                displayHand(playerHand, playerHandDiv, true);
                displayHand(aiHand, aiHandDiv, false);

                // プレイヤーの選択をリセット
                playerSelected = null;
                playerSelectedIndex = null;

                // メッセージをリセット
                messageDiv.innerText = '次のラウンド！ 手札から1枚選んでください。';

                // 選択ボタンを有効化
                enableChoices();
            }

            // リセットボタンのクリックイベント
            resetButton.addEventListener('click', () => {
                resetModal.style.display = 'flex';
            });

            // リセット確認ボタンのクリックイベント
            confirmResetButton.addEventListener('click', () => {
                // リセット処理
                playerGold = 1000; // 数値として設定
                playerGoldSpan.innerText = playerGold;
                localStorage.setItem('playerGold', playerGold.toString()); // 文字列として保存

                // ゲーム履歴を削除
                localStorage.removeItem('jankenGameHistory');
                localStorage.removeItem('playerHistory'); // プレイヤー履歴も削除

                // スコアをリセット
                playerScore = 0;
                aiScore = 0;
                playerScoreSpan.innerText = playerScore;
                aiScoreSpan.innerText = aiScore;

                // 選択結果をリセット
                playerChoiceIcon.innerText = '-';
                computerChoiceIcon.innerText = '-';
                resultDisplay.style.display = 'none';
                messageDiv.classList.remove('tie');
                messageDiv.innerText = 'ゲームを開始しましょう！ 各プレイヤーは手札から1枚選んでください。';

                // 手札を再生成
                playerHand = generateHand();
                aiHand = generateHand();
                displayHand(playerHand, playerHandDiv, true);
                displayHand(aiHand, aiHandDiv, false);

                // ラウンド数をリセット
                roundCount = 0;

                // 全額ベットフラグをリセット
                isAllIn = false;

                // currentBetをリセット
                currentBet = 0;

                // リセットボタンと続けるボタンを非表示
                resetButton.style.display = 'none';
                continueButton.style.display = 'none';

                // 掛け金選択モーダルを表示
                showBettingModal();

                // 選択ボタンを有効化
                enableChoices();

                // リセットモーダルを非表示
                resetModal.style.display = 'none';
            });

            // リセットキャンセルボタンのクリックイベント
            cancelResetButton.addEventListener('click', () => {
                resetModal.style.display = 'none';
            });

            // ゲーム履歴モーダルの表示関数
            function showHistory() {
                const gameHistory = JSON.parse(localStorage.getItem('jankenGameHistory')) || [];
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';

                // グラフデータの準備
                const labels = [];
                const goldData = [];
                let cumulativeGold = 1000; // 初期ゴールド

                gameHistory.forEach((game, index) => {
                    labels.push(`Game ${index + 1}`);
                    cumulativeGold += game.goldChange;
                    goldData.push(cumulativeGold);

                    // リストアイテムの作成
                    const listItem = document.createElement('li');
                    let historyText = `${index + 1}. 日時: ${game.date}, あなたのスコア: ${game.playerScore} - AIのスコア: ${game.aiScore}`;
                    if (game.goldChange > 0) {
                        historyText += `, ゴールド獲得: +${game.goldChange}ゴールド`;
                    } else if (game.goldChange < 0) {
                        historyText += `, ゴールド減少: ${game.goldChange}ゴールド`;
                    } else {
                        historyText += `, ゴールド変動なし`;
                    }
                    listItem.innerHTML = historyText;
                    historyList.appendChild(listItem);
                });

                // グラフの描画
                const ctx = document.getElementById('history-chart').getContext('2d');
                if (window.historyChart instanceof Chart) {
                    window.historyChart.destroy();
                }
                window.historyChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '所持金の推移',
                            data: goldData,
                            borderColor: 'rgba(255, 215, 0, 1)',
                            backgroundColor: 'rgba(255, 215, 0, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: false, // マイナスも表示できるように
                                suggestedMin: Math.min(...goldData, 0) - 5000,
                                suggestedMax: Math.max(...goldData) + 5000,
                                title: {
                                    display: true,
                                    text: 'ゴールド'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'ゲーム数'
                                }
                            }
                        }
                    }
                });

                // モーダルを表示
                historyModal.style.display = 'flex';
            }

            // ゲーム履歴モーダルの閉鎖イベント
            closeHistory.addEventListener('click', () => {
                historyModal.style.display = 'none';
            });

            // 掛け金選択モーダルの表示関数
            function showBettingModal() {
                // currentBetをリセット
                currentBet = 0;
                bettingModal.style.display = 'flex';

                // 「全額ベット」ボタンの表示制御
                const allInButton = document.querySelector('.bet-button[data-bet="all-in"]');
                if (playerGold > 0) {
                    allInButton.style.display = 'inline-block';
                } else {
                    allInButton.style.display = 'none';
                }
            }

            // 掛け金選択モーダルの閉鎖イベント
            closeBetting.addEventListener('click', () => {
                // ゲームを開始しない場合、リロードするか別の処理を行う
                bettingModal.style.display = 'none';
                alert('掛け金を選択しない場合、ゲームを開始できません。ページをリロードしてください。');
            });

            // 掛け金選択ボタンのクリックイベント
            bettingButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const selectedBetData = button.dataset.bet;
                    let selectedBet;

                    if (selectedBetData === 'all-in') {
                        selectedBet = playerGold;
                        if (playerGold <= 0) {
                            alert('所持金がありません。掛け金を選択してください。');
                            return;
                        }
                        isAllIn = true; // 全額ベットフラグを設定
                    } else {
                        selectedBet = parseInt(selectedBetData, 10);
                        if (isNaN(selectedBet)) {
                            alert('無効な掛け金が選択されました。');
                            return;
                        }
                        // 所持金が掛け金より少ない場合でも選択可能
                        // ただし、「全額ベット」は別途制御
                        if (selectedBet > playerGold) {
                            alert(`所持金が不足しています。所持金: ${playerGold}ゴールド`);
                            // プレイヤーの所持金がマイナスの場合でも選択可能
                            // ここでは掛け金を引き落とす
                            // No return; allow the bet
                        }
                        isAllIn = false; // 全額ベットではない
                    }

                    currentBet = selectedBet;

                    // 掛け金が正の数であることを確認
                    if (currentBet <= 0 || isNaN(currentBet)) {
                        alert('無効な掛け金が選択されました。');
                        return;
                    }

                    // 所持金から掛け金を引き落とす
                    playerGold -= currentBet;
                    playerGoldSpan.innerText = playerGold;
                    localStorage.setItem('playerGold', playerGold.toString()); // ローカルストレージに保存

                    // gold.mp3 のサウンドエフェクトを再生
                    goldSound.currentTime = 0;
                    goldSound.play().catch(error => {
                        console.error('ゴールド音声の再生に失敗しました:', error);
                    });

                    bettingModal.style.display = 'none';
                    messageDiv.innerText = `掛け金: ${currentBet}ゴールドを支払いました。手札から1枚選んでください。`;
                });
            });

            // 「次のゲームを続ける」ボタンのクリックイベント
            continueButton.addEventListener('click', () => {
                // スコアをリセット
                playerScore = 0;
                aiScore = 0;
                playerScoreSpan.innerText = playerScore;
                aiScoreSpan.innerText = aiScore;

                // 選択結果をリセット
                playerChoiceIcon.innerText = '-';
                computerChoiceIcon.innerText = '-';
                resultDisplay.style.display = 'none';
                messageDiv.classList.remove('tie');

                // プレイヤーとAIの手札を再生成
                playerHand = generateHand();
                aiHand = generateHand();
                displayHand(playerHand, playerHandDiv, true);
                displayHand(aiHand, aiHandDiv, false);

                // ラウンド数をリセット
                roundCount = 0;

                // 全額ベットフラグをリセット
                isAllIn = false;

                // currentBetをリセット
                currentBet = 0;

                // リセットボタンと続けるボタンを非表示
                resetButton.style.display = 'none';
                continueButton.style.display = 'none';

                // 掛け金選択モーダルを表示
                showBettingModal();

                // 選択ボタンを有効化
                enableChoices();
            });

            // AIの戦略的な選択関数
            function getAIStrategyChoice() {
                // プレイヤーの選択履歴を取得
                const history = JSON.parse(localStorage.getItem('playerHistory')) || { rock: 0, paper: 0, scissors: 0 };
                const mostChosen = Object.keys(history).reduce((a, b) => history[a] > history[b] ? a : b, 'rock');

                // カウンターを選択
                let counter;
                switch (mostChosen) {
                    case 'rock':
                        counter = 'paper';
                        break;
                    case 'paper':
                        counter = 'scissors';
                        break;
                    case 'scissors':
                        counter = 'rock';
                        break;
                    default:
                        counter = getRandomChoice();
                }

                // AIの手札にカウンターが存在するか確認
                const matchingIndices = [];
                aiHand.forEach((choice, index) => {
                    if (choice === counter) {
                        matchingIndices.push(index);
                    }
                });

                if (matchingIndices.length > 0) {
                    // カウンターが存在する場合、ランダムに選択
                    const randomIndex = matchingIndices[Math.floor(Math.random() * matchingIndices.length)];
                    return { choice: counter, index: randomIndex };
                } else {
                    // カウンターが存在しない場合はランダムに選択
                    const randomChoice = getRandomChoice();
                    const randomIndices = [];
                    aiHand.forEach((choice, index) => {
                        if (choice === randomChoice) {
                            randomIndices.push(index);
                        }
                    });
                    if (randomIndices.length > 0) {
                        const randomIndex = randomIndices[Math.floor(Math.random() * randomIndices.length)];
                        return { choice: randomChoice, index: randomIndex };
                    } else {
                        // AIの手札が空の場合
                        return { choice: null, index: -1 };
                    }
                }
            }

            // フォールバックAI選択関数（AIが手を出さない場合に呼び出す）
            function getFallbackAIChoice() {
                if (aiHand.length === 0) {
                    return { choice: null, index: -1 };
                }
                // 何らかの理由でAIが選択しなかった場合、ランダムに選択
                const randomIndex = Math.floor(Math.random() * aiHand.length);
                return { choice: aiHand[randomIndex], index: randomIndex };
            }

            // ランダムに選択する関数
            function getRandomChoice() {
                const options = ['rock', 'paper', 'scissors'];
                return options[Math.floor(Math.random() * options.length)];
            }

            // プレイヤーの選択履歴を更新する関数
            function updatePlayerHistory(playerChoice) {
                const history = JSON.parse(localStorage.getItem('playerHistory')) || { rock: 0, paper: 0, scissors: 0 };
                if (history.hasOwnProperty(playerChoice)) {
                    history[playerChoice]++;
                } else {
                    history[playerChoice] = 1;
                }
                localStorage.setItem('playerHistory', JSON.stringify(history));
            }

            // ゲームの初期化関数
            function init() {
                // 初期手札生成
                playerHand = generateHand();
                aiHand = generateHand();
                displayHand(playerHand, playerHandDiv, true);
                displayHand(aiHand, aiHandDiv, false);

                // 初期ゴールドの設定
                const storedGold = localStorage.getItem('playerGold');
                if (storedGold !== null) {
                    playerGold = parseInt(storedGold, 10);
                    if (isNaN(playerGold)) { // NaNチェック
                        playerGold = 1000;
                        localStorage.setItem('playerGold', playerGold.toString());
                    }
                } else {
                    playerGold = 1000;
                    localStorage.setItem('playerGold', playerGold.toString());
                }
                playerGoldSpan.innerText = playerGold;

                // UIの初期化
                setupUI();

                // 掛け金選択モーダルを表示
                showBettingModal();

                // BGMの再生許可
                window.addEventListener('click', () => {
                    if (bgm.paused) {
                        bgm.play().catch(error => {
                            console.error('BGMの再生に失敗しました:', error);
                        });
                    }
                }, { once: true });
            }

            // UIの初期化関数
            function setupUI() {
                // キーボードナビゲーションは既にカードに追加済み
                // 他のUI関連の初期化があればここに追加
                historyButton.addEventListener('click', showHistory);

                // ミュートボタンの機能追加
                muteButton.addEventListener('click', () => {
                    if (bgm.muted) {
                        bgm.muted = false;
                        muteButton.innerText = 'ミュート';
                    } else {
                        bgm.muted = true;
                        muteButton.innerText = '音声オン';
                    }
                });
            }

            // ゲームの初期化
            init();

            // 選択ボタンを無効化する関数
            function disableChoices() {
                const cards = playerHandDiv.getElementsByClassName('card');
                for (let card of cards) {
                    card.style.cursor = 'not-allowed';
                    card.style.opacity = '0.6';
                }
            }

            // 選択ボタンを有効化する関数
            function enableChoices() {
                const cards = playerHandDiv.getElementsByClassName('card');
                for (let card of cards) {
                    card.style.cursor = 'pointer';
                    card.style.opacity = '1';
                }
            }
        })();
    </script>
</body>
</html>
